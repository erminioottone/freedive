<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#000000" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>CO₂ Training - Custom Static Apnea Trainer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body { 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        #root { 
            width: 100vw; 
            min-height: 100vh;
            min-height: 100dvh;
        }
        input, select, textarea {
            font-size: 16px;
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- Helper Functions ---
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        };

        const roundTime = (seconds) => {
            if (seconds <= 60) return Math.round(seconds / 5) * 5;
            if (seconds <= 300) return Math.round(seconds / 15) * 15;
            return Math.round(seconds / 30) * 30;
        };

        const generateCO2Tables = (initialBH, initialRecovery, weeks = 6) => {
            const tables = {};
            for (let week = 1; week <= weeks; week++) {
                const weekName = `Week ${week}`;
                const weeklyTable = [];
                const bhIncrement = Math.floor(initialBH * 0.3);
                const rawWeeklyBH = initialBH + (bhIncrement * (week - 1));
                const weeklyBH = roundTime(rawWeeklyBH);

                const recoveryDecrement = Math.floor(initialRecovery * 0.15);
                const rawBaseRecovery = Math.max(30, initialRecovery - (recoveryDecrement * (week - 1)));
                const baseRecovery = roundTime(rawBaseRecovery);

                for (let rep = 0; rep < 8; rep++) {
                    const recoveryReduction = Math.floor(baseRecovery * 0.05 * rep);
                    const rawFinalRecovery = Math.max(15, baseRecovery - recoveryReduction);
                    const finalRecovery = roundTime(rawFinalRecovery);

                    weeklyTable.push({
                        bh: weeklyBH,
                        rb: finalRecovery
                    });
                }
                tables[weekName] = weeklyTable;
            }
            return tables;
        };

        // --- Audio Hook ---
        const useAudio = () => {
            const audioContextRef = useRef(null);

            const ensureContext = useCallback(async () => {
                if (!audioContextRef.current) {
                    const Ctx = window.AudioContext || window.webkitAudioContext;
                    if (!Ctx) return null;
                    audioContextRef.current = new Ctx();
                }
                const ctx = audioContextRef.current;
                if (ctx.state === 'suspended') {
                    try { await ctx.resume(); } catch (e) { console.warn('Audio context resume failed:', e); }
                }
                return ctx;
            }, []);

            const playSound = useCallback(async (type) => {
                const ctx = await ensureContext();
                if (!ctx) return;

                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                let duration = 0.6;
                switch(type) {
                    case 'start':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
                        gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
                        duration = 0.5;
                        break;
                    case 'end':
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(880, ctx.currentTime);
                        gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1);
                        duration = 1.0;
                        break;
                    case 'rep':
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(440, ctx.currentTime);
                        gainNode.gain.setValueAtTime(0.35, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
                        duration = 0.25;
                        break;
                }
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration + 0.02);
            }, [ensureContext]);

            return { playSound, ensureContext };
        };

        // --- Setup Screen Component ---
        const SetupScreen = ({ onStart }) => {
            const [bhMinutes, setBhMinutes] = useState(1);
            const [bhSeconds, setBhSeconds] = useState(30);
            const [recoveryMinutes, setRecoveryMinutes] = useState(2);
            const [recoverySeconds, setRecoverySeconds] = useState(0);
            const [weeks, setWeeks] = useState(6);
            const [selectedWeek, setSelectedWeek] = useState(1);

            const handleStart = () => {
                const totalBH = bhMinutes * 60 + bhSeconds;
                const totalRecovery = recoveryMinutes * 60 + recoverySeconds;
                
                if (totalBH > 0 && totalRecovery > 0) {
                    onStart({
                        breathHold: totalBH,
                        recovery: totalRecovery,
                        weeks: weeks,
                        selectedWeek: selectedWeek
                    });
                }
            };

            return React.createElement('div', {
                className: "bg-black min-h-screen min-h-[100dvh] flex flex-col items-center justify-start py-6 sm:justify-center text-white px-4 font-sans overflow-y-auto"
            },
                React.createElement('div', {
                    className: "w-full max-w-lg mx-auto bg-gray-900/50 rounded-2xl shadow-2xl p-6 sm:p-8 border border-gray-700"
                },
                    React.createElement('header', { className: "text-center mb-6" },
                        React.createElement('h1', { className: "text-4xl sm:text-5xl font-bold text-cyan-400 mb-2" }, "CO₂ Training"),
                        React.createElement('p', { className: "text-sm sm:text-base text-gray-400" }, "Custom Static Apnea Trainer")
                    ),

                    React.createElement('div', { className: "space-y-6" },
                        // Breath Hold Time
                        React.createElement('div', { className: "bg-gray-800 rounded-lg p-4 border border-gray-700" },
                            React.createElement('label', { className: "block text-sm font-medium text-gray-300 mb-3" }, "Initial Breath Hold Time"),
                            React.createElement('div', { className: "flex items-center justify-center space-x-3" },
                                React.createElement('input', {
                                    type: "number",
                                    min: "0",
                                    max: "10",
                                    value: bhMinutes,
                                    onChange: (e) => setBhMinutes(parseInt(e.target.value) || 0),
                                    className: "w-16 sm:w-20 bg-gray-700 border border-gray-600 text-white text-center text-lg rounded p-3"
                                }),
                                React.createElement('span', { className: "text-gray-400 font-medium" }, "min"),
                                React.createElement('input', {
                                    type: "number",
                                    min: "0",
                                    max: "59",
                                    value: bhSeconds,
                                    onChange: (e) => setBhSeconds(parseInt(e.target.value) || 0),
                                    className: "w-16 sm:w-20 bg-gray-700 border border-gray-600 text-white text-center text-lg rounded p-3"
                                }),
                                React.createElement('span', { className: "text-gray-400 font-medium" }, "sec")
                            )
                        ),

                        // Recovery Time
                        React.createElement('div', { className: "bg-gray-800 rounded-lg p-4 border border-gray-700" },
                            React.createElement('label', { className: "block text-sm font-medium text-gray-300 mb-3" }, "Initial Recovery Time"),
                            React.createElement('div', { className: "flex items-center justify-center space-x-3" },
                                React.createElement('input', {
                                    type: "number",
                                    min: "0",
                                    max: "10",
                                    value: recoveryMinutes,
                                    onChange: (e) => setRecoveryMinutes(parseInt(e.target.value) || 0),
                                    className: "w-16 sm:w-20 bg-gray-700 border border-gray-600 text-white text-center text-lg rounded p-3"
                                }),
                                React.createElement('span', { className: "text-gray-400 font-medium" }, "min"),
                                React.createElement('input', {
                                    type: "number",
                                    min: "0",
                                    max: "59",
                                    value: recoverySeconds,
                                    onChange: (e) => setRecoverySeconds(parseInt(e.target.value) || 0),
                                    className: "w-16 sm:w-20 bg-gray-700 border border-gray-600 text-white text-center text-lg rounded p-3"
                                }),
                                React.createElement('span', { className: "text-gray-400 font-medium" }, "sec")
                            )
                        ),

                        // Number of Weeks
                        React.createElement('div', { className: "bg-gray-800 rounded-lg p-4 border border-gray-700" },
                            React.createElement('label', { className: "block text-sm font-medium text-gray-300 mb-3" }, "Training Program Length"),
                            React.createElement('select', {
                                value: weeks,
                                onChange: (e) => setWeeks(parseInt(e.target.value)),
                                className: "w-full bg-gray-700 border border-gray-600 text-white text-center text-lg rounded-lg p-3"
                            },
                                [4, 5, 6, 7, 8, 9, 10].map(w => 
                                    React.createElement('option', { key: w, value: w }, `${w} Weeks`)
                                )
                            )
                        ),

                        // Starting Week
                        React.createElement('div', { className: "bg-gray-800 rounded-lg p-4 border border-gray-700" },
                            React.createElement('label', { className: "block text-sm font-medium text-gray-300 mb-3" }, "Start at Week"),
                            React.createElement('select', {
                                value: selectedWeek,
                                onChange: (e) => setSelectedWeek(parseInt(e.target.value)),
                                className: "w-full bg-gray-700 border border-gray-600 text-white text-center text-lg rounded-lg p-3"
                            },
                                Array.from({length: weeks}, (_, i) => i + 1).map(w => 
                                    React.createElement('option', { key: w, value: w }, `Week ${w}`)
                                )
                            )
                        )
                    ),

                    React.createElement('button', {
                        onClick: handleStart,
                        className: "w-full mt-8 bg-gradient-to-r from-cyan-500 to-green-500 hover:from-cyan-600 hover:to-green-600 active:from-cyan-700 active:to-green-700 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg transform active:scale-95 transition-all"
                    }, "Start Training"),

                    React.createElement('footer', { className: "text-center mt-6 text-gray-500 text-xs sm:text-sm" },
                        React.createElement('p', null, "Set your parameters and begin your CO₂ tolerance training."),
                        React.createElement('p', { className: "mt-1" }, "Tables will auto-generate based on your inputs.")
                    )
                )
            );
        };

        // --- Timer Display Component ---
        const TimerDisplay = ({ time, phase, rep, totalReps, initialDuration }) => {
            const progress = initialDuration > 0 ? time / initialDuration : 0;

            return React.createElement('div', {
                className: "relative flex flex-col items-center justify-center bg-gray-900 rounded-full w-64 h-64 sm:w-80 sm:h-80 md:w-96 md:h-96 mx-auto my-6 border-4 sm:border-8 border-gray-800 shadow-lg",
                'aria-live': "polite",
                role: "status"
            },
                React.createElement('svg', {
                    className: "absolute inset-0 w-full h-full",
                    viewBox: "0 0 200 200",
                    style: {
                        transform: 'rotate(-90deg)'
                    }
                },
                    React.createElement('circle', {
                        cx: "100",
                        cy: "100",
                        r: "90",
                        fill: 'transparent',
                        stroke: '#4b5563',
                        strokeWidth: "12"
                    }),
                    React.createElement('circle', {
                        cx: "100",
                        cy: "100",
                        r: "90",
                        fill: 'transparent',
                        stroke: '#fb923c',
                        strokeWidth: "12",
                        strokeDasharray: `${2 * Math.PI * 90}`,
                        strokeDashoffset: `${2 * Math.PI * 90 * (1 - progress)}`,
                        strokeLinecap: 'round',
                        style: {
                            transition: 'stroke-dashoffset 1s linear',
                            filter: 'drop-shadow(0 0 8px rgba(251,146,60,0.7))'
                        }
                    })
                ),
                React.createElement('div', { className: "relative z-10 flex flex-col items-center justify-center px-2" },
                    React.createElement('div', { className: `text-5xl sm:text-7xl md:text-8xl font-mono font-bold ${phase === 'BH' ? 'text-cyan-400' : 'text-green-400'}` },
                        formatTime(time)
                    ),
                    React.createElement('div', { className: "text-xl sm:text-2xl md:text-3xl text-white mt-2 font-semibold" },
                        phase === 'BH' ? 'Breath Hold' : 'Recovery'
                    ),
                    React.createElement('div', { className: "text-base sm:text-lg md:text-xl text-gray-400 mt-1" },
                        `Rep ${rep} / ${totalReps}`
                    )
                )
            );
        };

        // --- Training Screen Component ---
        const TrainingScreen = ({ config, onExit }) => {
            const co2Tables = useMemo(() => 
                generateCO2Tables(config.breathHold, config.recovery, config.weeks), 
                [config.breathHold, config.recovery, config.weeks]
            );

            const [selectedTable, setSelectedTable] = useState(`Week ${config.selectedWeek}`);
            const [isRunning, setIsRunning] = useState(false);
            const [currentRep, setCurrentRep] = useState(0);
            const [currentPhase, setCurrentPhase] = useState('BH');
            const tableData = co2Tables[selectedTable];
            const totalReps = tableData.length;

            const initialFirst = tableData[0].bh;
            const [timeRemaining, setTimeRemaining] = useState(initialFirst);
            const [initialDuration, setInitialDuration] = useState(initialFirst);
            const [sessionFinished, setSessionFinished] = useState(false);

            const repRef = useRef(currentRep);
            const phaseRef = useRef(currentPhase);
            const timeRef = useRef(timeRemaining);
            const runningRef = useRef(isRunning);
            const intervalRef = useRef(null);

            const { playSound, ensureContext } = useAudio();

            useEffect(() => { repRef.current = currentRep; }, [currentRep]);
            useEffect(() => { phaseRef.current = currentPhase; }, [currentPhase]);
            useEffect(() => { timeRef.current = timeRemaining; }, [timeRemaining]);
            useEffect(() => { runningRef.current = isRunning; }, [isRunning]);

            useEffect(() => {
                if (co2Tables[selectedTable]) {
                    const initial = co2Tables[selectedTable][0].bh;
                    setIsRunning(false);
                    setCurrentRep(0);
                    setCurrentPhase('BH');
                    setTimeRemaining(initial);
                    setInitialDuration(initial);
                    setSessionFinished(false);

                    repRef.current = 0;
                    phaseRef.current = 'BH';
                    timeRef.current = initial;
                }
            }, [selectedTable, co2Tables]);

            useEffect(() => {
                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                        intervalRef.current = null;
                    }
                };
            }, []);

            const tick = useCallback(() => {
                if (!runningRef.current) return;

                const next = Math.max(0, timeRef.current - 1);
                setTimeRemaining(next);
                timeRef.current = next;

                if (next === 0) {
                    const phase = phaseRef.current;
                    const rep = repRef.current;

                    if (phase === 'BH') {
                        playSound('end');
                        const nextDuration = tableData[rep].rb;
                        setCurrentPhase('RB');
                        phaseRef.current = 'RB';
                        setInitialDuration(nextDuration);
                        setTimeRemaining(nextDuration);
                        timeRef.current = nextDuration;
                    } else {
                        if (rep < totalReps - 1) {
                            playSound('rep');
                            const newRep = rep + 1;
                            repRef.current = newRep;
                            setCurrentRep(newRep);

                            const nextDuration = tableData[newRep].bh;
                            setCurrentPhase('BH');
                            phaseRef.current = 'BH';
                            setInitialDuration(nextDuration);
                            setTimeRemaining(nextDuration);
                            timeRef.current = nextDuration;
                        } else {
                            playSound('end');
                            setSessionFinished(true);
                            setIsRunning(false);
                            runningRef.current = false;

                            if (intervalRef.current) {
                                clearInterval(intervalRef.current);
                                intervalRef.current = null;
                            }
                        }
                    }
                }
            }, [playSound, tableData, totalReps]);

            useEffect(() => {
                if (isRunning && !intervalRef.current) {
                    ensureContext().catch(() => {});
                    intervalRef.current = setInterval(tick, 1000);
                } else if (!isRunning && intervalRef.current) {
                    clearInterval(intervalRef.current);
                    intervalRef.current = null;
                }
            }, [isRunning, tick, ensureContext]);

            const handleStart = async () => {
                await ensureContext().catch(() => {});
                playSound('start');
                setIsRunning(true);
                runningRef.current = true;
                setSessionFinished(false);
            };

            const handleStop = () => {
                setIsRunning(false);
                runningRef.current = false;
            };

            const handleReset = () => {
                if (sessionFinished) return;
                setIsRunning(false);
                runningRef.current = false;
                setCurrentRep(0);
                repRef.current = 0;
                setCurrentPhase('BH');
                phaseRef.current = 'BH';

                const initial = co2Tables[selectedTable][0].bh;
                setInitialDuration(initial);
                setTimeRemaining(initial);
                timeRef.current = initial;

                if (intervalRef.current) {
                    clearInterval(intervalRef.current);
                    intervalRef.current = null;
                }
                setSessionFinished(false);
                playSound('end');
            };

            const progress = useMemo(() => {
                const totalSteps = totalReps * 2;
                let completedBefore = currentRep * 2;
                let withinStepProgress = initialDuration > 0 ? (initialDuration - timeRemaining) / initialDuration : 0;

                let progressSteps = completedBefore;
                if (currentPhase === 'BH') {
                    progressSteps += withinStepProgress;
                } else {
                    progressSteps += 1 + withinStepProgress;
                }

                return Math.max(0, Math.min(1, progressSteps / totalSteps));
            }, [currentRep, currentPhase, timeRemaining, initialDuration, totalReps]);

            return React.createElement('div', {
                className: "bg-black min-h-screen min-h-[100dvh] flex flex-col items-center justify-start py-3 sm:py-4 text-white px-3 sm:px-4 font-sans overflow-y-auto"
            },
                React.createElement('div', {
                    className: "w-full max-w-2xl mx-auto"
                },
                    React.createElement('div', { className: "flex items-center justify-between mb-4" },
                        React.createElement('button', {
                            onClick: onExit,
                            className: "text-gray-400 hover:text-white transition-colors text-sm sm:text-base"
                        }, "← Back to Setup"),
                        React.createElement('h1', { className: "text-2xl sm:text-3xl font-bold text-cyan-400" }, selectedTable)
                    ),

                    React.createElement(TimerDisplay, {
                        time: timeRemaining,
                        phase: currentPhase,
                        rep: currentRep + 1,
                        totalReps: totalReps,
                        initialDuration: initialDuration
                    }),

                    React.createElement('div', { className: "my-4 px-2" },
                        React.createElement('div', { className: "flex items-center justify-between mb-2 text-xs sm:text-sm text-gray-400" },
                            React.createElement('div', null, "Session Progress"),
                            React.createElement('div', null, `${Math.round(progress * 100)}%`)
                        ),
                        React.createElement('div', { className: "w-full h-3 sm:h-4 bg-gray-800 rounded-full overflow-hidden border border-gray-700 shadow-inner" },
                            React.createElement('div', {
                                className: "h-full rounded-full transition-all duration-500 ease-linear",
                                style: { 
                                    width: `${progress * 100}%`, 
                                    background: 'linear-gradient(90deg,#06b6d4,#10b981)' 
                                }
                            })
                        )
                    ),

                    React.createElement('div', { className: "my-4 sm:my-6" },
                        React.createElement('label', { 
                            htmlFor: "week-select", 
                            className: "block text-sm sm:text-base font-medium text-gray-300 mb-2 text-center" 
                        }, "Change Week"),
                        React.createElement('select', {
                            id: "week-select",
                            value: selectedTable,
                            onChange: (e) => setSelectedTable(e.target.value),
                            disabled: isRunning,
                            className: "block w-full max-w-xs mx-auto bg-gray-800 border border-gray-700 text-white text-base sm:text-lg rounded-lg p-2 sm:p-3 disabled:opacity-50"
                        },
                            Object.keys(co2Tables).map((tableName) => 
                                React.createElement('option', { key: tableName, value: tableName }, tableName)
                            )
                        )
                    ),

                    React.createElement('div', { className: "flex justify-center items-center space-x-3 sm:space-x-4 my-6" },
                        !isRunning ? 
                            React.createElement('button', {
                                onClick: handleStart,
                                className: "bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full text-xl sm:text-2xl shadow-lg transform active:scale-95 transition-all"
                            }, "Start") :
                            React.createElement('button', {
                                onClick: handleStop,
                                className: "bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full text-xl sm:text-2xl shadow-lg transform active:scale-95 transition-all"
                            }, "Stop"),
                        React.createElement('button', {
                            onClick: handleReset,
                            disabled: sessionFinished,
                            className: `font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full text-xl sm:text-2xl shadow-lg transition-all ` +
                                (sessionFinished
                                    ? 'bg-gray-600 text-white opacity-50 cursor-not-allowed'
                                    : 'bg-gray-500 hover:bg-gray-600 active:bg-gray-700 transform active:scale-95')
                        }, "Reset")
                    ),

                    React.createElement('footer', { className: "text-center mt-6 text-gray-500 text-xs sm:text-sm" },
                        React.createElement('p', null, "Hold your breath during 'Breath Hold'."),
                        React.createElement('p', null, "Breathe normally during 'Recovery'.")
                    )
                )
            );
        };

        // --- Main App ---
        const App = () => {
            const [screen, setScreen] = useState('setup');
            const [trainingConfig, setTrainingConfig] = useState(null);

            const handleStartTraining = (config) => {
                setTrainingConfig(config);
                setScreen('training');
            };

            const handleExitTraining = () => {
                setScreen('setup');
            };

            return screen === 'setup' 
                ? React.createElement(SetupScreen, { onStart: handleStartTraining })
                : React.createElement(TrainingScreen, { 
                    config: trainingConfig, 
                    onExit: handleExitTraining 
                });
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
