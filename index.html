<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CO₂ Training">
    <title>CO₂ Training - Static Apnea Trainer</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNPMiBUcmFpbmluZyIsCiAgInNob3J0X25hbWUiOiAiQ08yIFRyYWluaW5nIiwKICAiZGVzY3JpcHRpb24iOiAiU3RhdGljIEFwbmVhIFRyYWluZXIiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklqNDhZMmx5WTJ4bElHTjRQU0l4TWpnaUlHTjVQU0l4TWpnaUlISXlPU0k0TVNJZ1ptbHNiRDBpSTJONVpXNDBNeUl2UGp3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjI1NngyNTYiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Prevent zoom on iOS when focusing inputs */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Hide address bar on mobile */
        html, body {
            height: 100vh;
            overflow-x: hidden;
        }
        
        /* Prevent pull-to-refresh */
        body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }
        
        /* Better button touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Prevent text selection on UI elements */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-black">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- Data for CO2 Tables ---
        const co2Tables = {
          'Week 1': [
            { bh: 90, rb: 120 }, { bh: 90, rb: 115 }, { bh: 90, rb: 110 },
            { bh: 90, rb: 105 }, { bh: 90, rb: 100 }, { bh: 90, rb: 95 },
            { bh: 90, rb: 90 }, { bh: 90, rb: 85 }
          ],
          'Week 2': [
            { bh: 120, rb: 110 }, { bh: 120, rb: 105 }, { bh: 120, rb: 100 },
            { bh: 120, rb: 95 }, { bh: 120, rb: 90 }, { bh: 120, rb: 85 },
            { bh: 120, rb: 80 }, { bh: 120, rb: 75 }
          ],
          'Week 3': [
            { bh: 150, rb: 100 }, { bh: 150, rb: 95 }, { bh: 150, rb: 90 },
            { bh: 150, rb: 85 }, { bh: 150, rb: 80 }, { bh: 150, rb: 75 },
            { bh: 150, rb: 70 }, { bh: 150, rb: 65 }
          ],
          'Week 4': [
            { bh: 180, rb: 90 }, { bh: 180, rb: 85 }, { bh: 180, rb: 80 },
            { bh: 180, rb: 75 }, { bh: 180, rb: 70 }, { bh: 180, rb: 65 },
            { bh: 180, rb: 60 }, { bh: 180, rb: 55 }
          ],
          'Week 5': [
            { bh: 240, rb: 80 }, { bh: 240, rb: 75 }, { bh: 240, rb: 70 },
            { bh: 240, rb: 65 }, { bh: 240, rb: 60 }, { bh: 240, rb: 55 },
            { bh: 240, rb: 50 }, { bh: 240, rb: 45 }
          ],
          'Week 6': [
            { bh: 270, rb: 70 }, { bh: 270, rb: 65 }, { bh: 300, rb: 60 },
            { bh: 300, rb: 55 }, { bh: 330, rb: 60 }, { bh: 330, rb: 55 },
            { bh: 360, rb: 50 }, { bh: 360, rb: 45 }
          ]
        };

        // --- Helper Functions ---
        const formatTime = (seconds) => {
          const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
          const secs = (seconds % 60).toString().padStart(2, '0');
          return `${mins}:${secs}`;
        };

        // --- Audio Cue Hook (mobile optimized) ---
        const useAudio = () => {
          const audioContextRef = useRef(null);
          const [audioEnabled, setAudioEnabled] = useState(false);

          const ensureContext = useCallback(async () => {
            if (!audioContextRef.current) {
              const Ctx = window.AudioContext || window.webkitAudioContext;
              if (!Ctx) return null;
              audioContextRef.current = new Ctx();
            }
            const ctx = audioContextRef.current;
            if (ctx.state === 'suspended') {
              try { 
                await ctx.resume(); 
                setAudioEnabled(true);
              } catch (e) { 
                console.warn('Audio context resume failed:', e);
                return null;
              }
            }
            return audioContextRef.current;
          }, []);

          const playSound = useCallback(async (type) => {
            const ctx = await ensureContext();
            if (!ctx) return;

            try {
              const oscillator = ctx.createOscillator();
              const gainNode = ctx.createGain();

              oscillator.connect(gainNode);
              gainNode.connect(ctx.destination);

              let duration = 0.6;

              if (type === 'start') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
                duration = 0.5;
              } else if (type === 'end') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(880, ctx.currentTime); // A5
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1);
                duration = 1.0;
              } else if (type === 'rep') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(440, ctx.currentTime); // A4
                gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
                duration = 0.25;
              }

              oscillator.start(ctx.currentTime);
              oscillator.stop(ctx.currentTime + duration + 0.02);
            } catch (e) {
              console.warn('Sound playback failed:', e);
            }
          }, [ensureContext]);

          return { playSound, ensureContext, audioEnabled };
        };

        // --- Wake Lock Hook for mobile ---
        const useWakeLock = () => {
          const wakeLockRef = useRef(null);

          const requestWakeLock = useCallback(async () => {
            if ('wakeLock' in navigator) {
              try {
                wakeLockRef.current = await navigator.wakeLock.request('screen');
                console.log('Wake lock acquired');
              } catch (e) {
                console.warn('Wake lock failed:', e);
              }
            }
          }, []);

          const releaseWakeLock = useCallback(async () => {
            if (wakeLockRef.current) {
              try {
                await wakeLockRef.current.release();
                wakeLockRef.current = null;
                console.log('Wake lock released');
              } catch (e) {
                console.warn('Wake lock release failed:', e);
              }
            }
          }, []);

          return { requestWakeLock, releaseWakeLock };
        };

        // --- Components ---
        const TimerDisplay = ({ time, phase, rep, totalReps, initialDuration }) => {
          const ringOpacity = initialDuration > 0 ? Math.max(0, Math.min(1, time / initialDuration)) : 0;

          return (
            <div
              className="relative flex flex-col items-center justify-center bg-gray-900 rounded-full w-[min(80vw,18rem)] h-[min(80vw,18rem)] sm:w-72 sm:h-72 mx-auto my-6 border-8 border-gray-800 shadow-lg no-select"
              aria-live="polite"
              role="status"
            >
              <div
                className="absolute inset-0 rounded-full border-4 border-orange-400 transition-all duration-700"
                style={{
                  opacity: ringOpacity,
                  boxShadow: `0 0 28px 6px rgba(251,146,60, ${ringOpacity * 0.72})`,
                }}
              />
              <div className="relative z-10 flex flex-col items-center justify-center">
                <div className={`text-5xl sm:text-7xl font-mono ${phase === 'BH' ? 'text-cyan-400' : 'text-green-400'}`}>
                  {formatTime(time)}
                </div>
                <div className="text-xl sm:text-2xl text-white mt-2">
                  {phase === 'BH' ? 'Breath Hold' : 'Recovery'}
                </div>
                <div className="text-lg text-gray-400 mt-1">
                  Rep: {rep} / {totalReps}
                </div>
              </div>
            </div>
          );
        };

        const SessionProgress = ({ currentRep, currentPhase, timeRemaining, initialDuration, totalReps }) => {
          const totalSteps = totalReps * 2;
          let completedBefore = currentRep * 2;
          let withinStepProgress = 0;

          if (initialDuration > 0) {
            withinStepProgress = (initialDuration - timeRemaining) / initialDuration;
          }

          let progressSteps = completedBefore;
          if (currentPhase === 'BH') {
            progressSteps += withinStepProgress;
          } else {
            progressSteps += 1 + withinStepProgress;
          }

          let progress = Math.max(0, Math.min(1, progressSteps / totalSteps));

          return (
            <div className="my-4 px-4">
              <div className="flex items-center justify-between mb-2 text-sm text-gray-400">
                <div>Session Progress</div>
                <div>{Math.round(progress * 100)}%</div>
              </div>
              <div className="w-full h-4 bg-gray-800 rounded-full overflow-hidden border border-gray-700 shadow-inner">
                <div
                  className="h-full rounded-full transition-all duration-500 ease-linear"
                  style={{ width: `${progress * 100}%`, background: 'linear-gradient(90deg,#06b6d4,#10b981)' }}
                />
              </div>
            </div>
          );
        };

        const TableSelector = ({ selectedTable, setSelectedTable, isRunning }) => (
          <div className="my-6 px-4">
            <label htmlFor="table-select" className="block text-lg font-medium text-gray-300 mb-2 text-center">
              Select CO2 Table
            </label>
            <select
              id="table-select"
              value={selectedTable}
              onChange={(e) => setSelectedTable(e.target.value)}
              disabled={isRunning}
              className="block w-full max-w-xs mx-auto bg-gray-800 border border-gray-700 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 p-3 disabled:opacity-50"
            >
              {Object.keys(co2Tables).map((tableName) => (
                <option key={tableName} value={tableName}>
                  {tableName}
                </option>
              ))}
            </select>
          </div>
        );

        const Controls = ({ isRunning, onStart, onStop, onReset, resetDisabled, audioEnabled }) => (
          <div className="px-4">
            <div className="flex justify-center items-center space-x-4 mb-4">
              {!isRunning ? (
                <button
                  onClick={onStart}
                  className="bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg transform hover:scale-105 active:scale-95 transition-transform no-select"
                >
                  Start
                </button>
              ) : (
                <button
                  onClick={onStop}
                  className="bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg transform hover:scale-105 active:scale-95 transition-transform no-select"
                >
                  Stop
                </button>
              )}
              <button
                onClick={onReset}
                disabled={resetDisabled}
                className={
                  `font-bold py-4 px-8 rounded-full text-xl shadow-lg transform transition-transform no-select ` +
                  (resetDisabled
                    ? 'bg-gray-600 text-white opacity-50 cursor-not-allowed'
                    : 'bg-gray-500 hover:bg-gray-600 active:bg-gray-700 hover:scale-105 active:scale-95 text-white')
                }
              >
                Reset
              </button>
            </div>
            {!audioEnabled && (
              <div className="text-center text-yellow-400 text-sm">
                Tap Start to enable audio cues
              </div>
            )}
          </div>
        );

        // --- Main App Component ---
        function App() {
          const [selectedTable, setSelectedTable] = useState('Week 1');
          const [isRunning, setIsRunning] = useState(false);
          const [currentRep, setCurrentRep] = useState(0);
          const [currentPhase, setCurrentPhase] = useState('BH');
          const tableData = co2Tables[selectedTable];
          const totalReps = tableData.length;

          const initialFirst = tableData[0].bh;
          const [timeRemaining, setTimeRemaining] = useState(initialFirst);
          const [initialDuration, setInitialDuration] = useState(initialFirst);
          const [sessionFinished, setSessionFinished] = useState(false);

          const repRef = useRef(currentRep);
          const phaseRef = useRef(currentPhase);
          const timeRef = useRef(timeRemaining);
          const runningRef = useRef(isRunning);
          const intervalRef = useRef(null);

          const { playSound, ensureContext, audioEnabled } = useAudio();
          const { requestWakeLock, releaseWakeLock } = useWakeLock();

          useEffect(() => { repRef.current = currentRep; }, [currentRep]);
          useEffect(() => { phaseRef.current = currentPhase; }, [currentPhase]);
          useEffect(() => { timeRef.current = timeRemaining; }, [timeRemaining]);
          useEffect(() => { runningRef.current = isRunning; }, [isRunning]);

          useEffect(() => {
            const initial = co2Tables[selectedTable][0].bh;
            setIsRunning(false);
            setCurrentRep(0);
            setCurrentPhase('BH');
            setTimeRemaining(initial);
            setInitialDuration(initial);
            setSessionFinished(false);

            repRef.current = 0;
            phaseRef.current = 'BH';
            timeRef.current = initial;
          }, [selectedTable]);

          useEffect(() => {
            return () => {
              if (intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
              }
              releaseWakeLock();
            };
          }, [releaseWakeLock]);

          const tick = useCallback(() => {
            if (!runningRef.current) return;

            const next = Math.max(0, timeRef.current - 1);
            setTimeRemaining(next);
            timeRef.current = next;

            if (next === 0) {
              const phase = phaseRef.current;
              const rep = repRef.current;

              if (phase === 'BH') {
                playSound('end');
                const nextDuration = tableData[rep].rb;
                setCurrentPhase('RB');
                phaseRef.current = 'RB';
                setInitialDuration(nextDuration);
                setTimeRemaining(nextDuration);
                timeRef.current = nextDuration;
              } else {
                if (rep < totalReps - 1) {
                  playSound('rep');
                  const newRep = rep + 1;
                  repRef.current = newRep;
                  setCurrentRep(newRep);

                  const nextDuration = tableData[newRep].bh;
                  setCurrentPhase('BH');
                  phaseRef.current = 'BH';
                  setInitialDuration(nextDuration);
                  setTimeRemaining(nextDuration);
                  timeRef.current = nextDuration;
                } else {
                  playSound('end');
                  setSessionFinished(true);
                  setIsRunning(false);
                  runningRef.current = false;
                  releaseWakeLock();

                  const initial = tableData[0].bh;
                  setCurrentRep(0);
                  repRef.current = 0;
                  setCurrentPhase('BH');
                  phaseRef.current = 'BH';
                  setInitialDuration(initial);
                  setTimeRemaining(initial);
                  timeRef.current = initial;

                  if (intervalRef.current) {
                    clearInterval(intervalRef.current);
                    intervalRef.current = null;
                  }
                }
              }
            }
          }, [playSound, tableData, totalReps, releaseWakeLock]);

          useEffect(() => {
            if (isRunning && !intervalRef.current) {
              ensureContext().catch(() => {});
              requestWakeLock();
              intervalRef.current = setInterval(() => {
                tick();
              }, 1000);
            }

            if (!isRunning && intervalRef.current) {
              clearInterval(intervalRef.current);
              intervalRef.current = null;
              releaseWakeLock();
            }

            return () => {
              if (intervalRef.current && !runningRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
              }
            };
          }, [isRunning, tick, ensureContext, requestWakeLock, releaseWakeLock]);

          const handleStart = async () => {
            await ensureContext().catch(() => {});
            playSound('start');
            setIsRunning(true);
            runningRef.current = true;
            setSessionFinished(false);
          };

          const handleStop = () => {
            setIsRunning(false);
            runningRef.current = false;
            if (intervalRef.current) {
              clearInterval(intervalRef.current);
              intervalRef.current = null;
            }
            releaseWakeLock();
          };

          const resetTimer = useCallback(() => {
            setIsRunning(false);
            runningRef.current = false;

            setCurrentRep(0);
            repRef.current = 0;

            setCurrentPhase('BH');
            phaseRef.current = 'BH';

            const initial = co2Tables[selectedTable][0].bh;
            setInitialDuration(initial);
            setTimeRemaining(initial);
            timeRef.current = initial;

            if (intervalRef.current) {
              clearInterval(intervalRef.current);
              intervalRef.current = null;
            }

            setSessionFinished(false);
            releaseWakeLock();
          }, [selectedTable, releaseWakeLock]);

          const handleReset = () => {
            if (sessionFinished) return;
            resetTimer();
            playSound('end');
          };

          // Keyboard shortcuts
          useEffect(() => {
            const handleKeyPress = (e) => {
              if (e.code === 'Space') {
                e.preventDefault();
                if (isRunning) {
                  handleStop();
                } else {
                  handleStart();
                }
              } else if (e.code === 'KeyR' && !sessionFinished) {
                e.preventDefault();
                handleReset();
              }
            };

            window.addEventListener('keydown', handleKeyPress);
            return () => window.removeEventListener('keydown', handleKeyPress);
          }, [isRunning, sessionFinished]);

          return (
            <div className="bg-black min-h-screen flex flex-col items-center justify-center text-white font-sans">
              <div className="w-full max-w-md mx-auto bg-gray-900/50 rounded-2xl shadow-2xl border border-gray-700 min-h-screen sm:min-h-0 sm:my-4">
                <header className="text-center pt-8 pb-4 px-4">
                  <h1 className="text-3xl sm:text-4xl font-bold text-cyan-400">CO₂ Training</h1>
                  <p className="text-gray-400">Static Apnea Trainer</p>
                </header>

                <main className="pb-8">
                  <TimerDisplay
                    time={timeRemaining}
                    phase={currentPhase}
                    rep={currentRep + 1}
                    totalReps={totalReps}
                    initialDuration={initialDuration}
                  />

                  <SessionProgress
                    currentRep={currentRep}
                    currentPhase={currentPhase}
                    timeRemaining={timeRemaining}
                    initialDuration={initialDuration}
                    totalReps={totalReps}
                  />

                  <TableSelector
                    selectedTable={selectedTable}
                    setSelectedTable={(val) => {
                      if (isRunning) return;
                      setSelectedTable(val);
                    }}
                    isRunning={isRunning}
                  />
                  
                  <Controls 
                    onStart={handleStart} 
                    onStop={handleStop} 
                    onReset={handleReset} 
                    isRunning={isRunning} 
                    resetDisabled={sessionFinished}
                    audioEnabled={audioEnabled}
                  />
                </main>

                <footer className="text-center pb-8 px-4 text-gray-500 text-sm">
                  <p>Hold your breath during the 'Breath Hold' phase.</p>
                  <p>Breathe normally during the 'Recovery' phase.</p>
                  <p className="mt-2 text-xs">Space: Start/Stop • R: Reset</p>
                </footer>
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>